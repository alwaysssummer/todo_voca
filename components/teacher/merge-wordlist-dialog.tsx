'use client'

import { useState, useEffect } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { Card } from '@/components/ui/card'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Loader2, Merge, AlertCircle, CheckCircle2 } from 'lucide-react'
import { supabase } from '@/lib/supabase'

interface Word {
  id: number
  wordlist_id: string
  word_text: string
  meaning: string
  example?: string
  example_translation?: string
  mnemonic?: string
  sequence_order: number
}

interface WordlistInfo {
  id: string
  name: string
  totalWords: number
  isAutoGenerated?: boolean
}

interface MergeWordlistDialogProps {
  open: boolean
  onClose: () => void
  wordlistIds: string[]
  onSuccess: () => void
}

interface MergeResult {
  uniqueWords: Word[]
  duplicates: string[]
}

/**
 * ì¤‘ë³µ ë‹¨ì–´ ìë™ ì œê±°
 * - word_text ê¸°ì¤€ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ê³µë°± ì •ê·œí™”)
 * - ì²« ë²ˆì§¸ ì¶œí˜„ë§Œ ìœ ì§€
 */
function removeDuplicateWords(words: Word[]): MergeResult {
  const seen = new Map<string, Word>()
  const duplicates: string[] = []
  
  for (const word of words) {
    // ì •ê·œí™”: ì†Œë¬¸ì + ì•ë’¤ ê³µë°± ì œê±° + ì—°ì† ê³µë°± â†’ ë‹¨ì¼ ê³µë°±
    const normalized = word.word_text
      .toLowerCase()
      .trim()
      .replace(/\s+/g, ' ')
    
    if (seen.has(normalized)) {
      duplicates.push(word.word_text)
    } else {
      seen.set(normalized, word)
    }
  }
  
  return {
    uniqueWords: Array.from(seen.values()),
    duplicates
  }
}

export function MergeWordlistDialog({
  open,
  onClose,
  wordlistIds,
  onSuccess
}: MergeWordlistDialogProps) {
  const [mergedName, setMergedName] = useState('')
  const [wordlistsInfo, setWordlistsInfo] = useState<WordlistInfo[]>([])
  const [totalWords, setTotalWords] = useState(0)
  const [isMerging, setIsMerging] = useState(false)
  const [error, setError] = useState('')
  const [loadingPreview, setLoadingPreview] = useState(true)

  // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    if (open && wordlistIds.length > 0) {
      loadPreview()
    }
  }, [open, wordlistIds])

  const loadPreview = async () => {
    try {
      setLoadingPreview(true)
      
      // ì„ íƒëœ ë‹¨ì–´ì¥ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìˆœì„œ ë³´ì¥)
      const wordlistsData: WordlistInfo[] = []
      let total = 0
      
      for (const id of wordlistIds) {
        const { data: wordlist, error } = await supabase
          .from('wordlists')
          .select('id, name, total_words')
          .eq('id', id)
          .single()
        
        if (error) throw error
        
        wordlistsData.push({
          id: wordlist.id,
          name: wordlist.name,
          totalWords: wordlist.total_words
        })
        
        total += wordlist.total_words
      }
      
      setWordlistsInfo(wordlistsData)
      setTotalWords(total)
      
      // ê¸°ë³¸ ì´ë¦„ ì œì•ˆ
      if (!mergedName) {
        const defaultName = `í†µí•© ë‹¨ì–´ì¥ (${total}ê°œ)`
        setMergedName(defaultName)
      }
      
    } catch (err: any) {
      console.error('ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì˜¤ë¥˜:', err)
      setError('ë‹¨ì–´ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
    } finally {
      setLoadingPreview(false)
    }
  }

  const handleMerge = async () => {
    setIsMerging(true)
    setError('')
    
    try {
      // ============================================
      // STEP 1: ìœ íš¨ì„± ê²€ì‚¬
      // ============================================
      
      if (wordlistIds.length < 2) {
        throw new Error('2ê°œ ì´ìƒì˜ ë‹¨ì–´ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”')
      }
      
      const trimmedName = mergedName.trim()
      if (!trimmedName) {
        throw new Error('ë‹¨ì–´ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”')
      }
      
      // ì´ë¦„ ì¤‘ë³µ í™•ì¸
      const { data: existing } = await supabase
        .from('wordlists')
        .select('id')
        .eq('name', trimmedName)
        .maybeSingle()
      
      if (existing) {
        throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤')
      }
      
      // ============================================
      // STEP 2: ë‹¨ì–´ ìˆ˜ì§‘ (ì„ íƒ ìˆœì„œ ë³´ì¥)
      // ============================================
      
      const allWords: Word[] = []
      
      for (const wordlistId of wordlistIds) {
        const { data: words, error } = await supabase
          .from('words')
          .select('*')
          .eq('wordlist_id', wordlistId)
          .order('sequence_order')
        
        if (error) throw error
        allWords.push(...(words || []))
      }
      
      const totalCollected = allWords.length
      console.log(`ğŸ“Š ìˆ˜ì§‘ëœ ì´ ë‹¨ì–´: ${totalCollected}ê°œ`)
      
      // ============================================
      // STEP 3: ì¤‘ë³µ ì œê±° â­
      // ============================================
      
      const { uniqueWords, duplicates } = removeDuplicateWords(allWords)
      
      console.log(`âœ‚ï¸ ì¤‘ë³µ ì œê±°: ${duplicates.length}ê°œ`)
      console.log(`âœ… ìµœì¢… ë‹¨ì–´: ${uniqueWords.length}ê°œ`)
      
      if (uniqueWords.length === 0) {
        throw new Error('í†µí•©í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤')
      }
      
      // ============================================
      // STEP 4: ìƒˆ ë‹¨ì–´ì¥ ìƒì„±
      // ============================================
      
      const teacherId = sessionStorage.getItem('teacher_id') || localStorage.getItem('teacher_id')
      
      const { data: newWordlist, error: wordlistError } = await supabase
        .from('wordlists')
        .insert({
          name: trimmedName,
          total_words: uniqueWords.length,
          created_by: teacherId,
          created_at: new Date().toISOString()
        })
        .select()
        .single()
      
      if (wordlistError) throw wordlistError
      
      console.log(`âœ… ë‹¨ì–´ì¥ ìƒì„±: ${newWordlist.id}`)
      
      // ============================================
      // STEP 5: ë‹¨ì–´ INSERT (Batch + sequence ì¬ì •ë ¬)
      // ============================================
      
      const wordsToInsert = uniqueWords.map((word, index) => ({
        wordlist_id: newWordlist.id,
        word_text: word.word_text,
        meaning: word.meaning,
        example: word.example || null,
        example_translation: word.example_translation || null,
        mnemonic: word.mnemonic || null,
        sequence_order: index + 1  // â­ 1ë¶€í„° ì¬ì •ë ¬
      }))
      
      // Batch INSERT (100ê°œì”©)
      const BATCH_SIZE = 100
      try {
        for (let i = 0; i < wordsToInsert.length; i += BATCH_SIZE) {
          const batch = wordsToInsert.slice(i, i + BATCH_SIZE)
          const { error: insertError } = await supabase
            .from('words')
            .insert(batch)
          
          if (insertError) throw insertError
        }
      } catch (insertError: any) {
        // ë¡¤ë°±: ë‹¨ì–´ì¥ ì‚­ì œ (CASCADEë¡œ ë‹¨ì–´ë„ ìë™ ì‚­ì œ)
        console.error('ë‹¨ì–´ INSERT ì‹¤íŒ¨, ë¡¤ë°± ì¤‘...')
        await supabase
          .from('wordlists')
          .delete()
          .eq('id', newWordlist.id)
        
        throw insertError
      }
      
      // ============================================
      // STEP 6: ì„±ê³µ ì•Œë¦¼
      // ============================================
      
      let message = `âœ… "${trimmedName}" ë‹¨ì–´ì¥ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n`
      message += `ğŸ“Š í†µê³„:\n`
      message += `- ì„ íƒí•œ ë‹¨ì–´ì¥: ${wordlistIds.length}ê°œ\n`
      message += `- ìˆ˜ì§‘ëœ ë‹¨ì–´: ${totalCollected}ê°œ\n`
      
      if (duplicates.length > 0) {
        message += `- ì¤‘ë³µ ì œê±°: ${duplicates.length}ê°œ\n`
        if (duplicates.length <= 5) {
          message += `  (${duplicates.join(', ')})\n`
        } else {
          message += `  (${duplicates.slice(0, 5).join(', ')} ì™¸ ${duplicates.length - 5}ê°œ)\n`
        }
      }
      
      message += `- ìµœì¢… ìƒì„±: ${uniqueWords.length}ê°œ\n\n`
      message += `âš ï¸ ì¤‘ìš” ì•ˆë‚´:\n`
      message += `ì´ í†µí•© ë‹¨ì–´ì¥ì€ ì‹ ê·œ í•™ìƒì—ê²Œ ë°°ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.\n`
      message += `(ê¸°ì¡´ í•™ìƒ ë°°ì • ì‹œ í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)`
      
      alert(message)
      
      // ì„±ê³µ í›„ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
      onSuccess()
      handleClose()
      
    } catch (error: any) {
      console.error('âŒ í†µí•© ì‹¤íŒ¨:', error)
      setError(error.message || 'í†µí•© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤')
    } finally {
      setIsMerging(false)
    }
  }

  const handleClose = () => {
    setMergedName('')
    setWordlistsInfo([])
    setTotalWords(0)
    setError('')
    setLoadingPreview(true)
    onClose()
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Merge className="w-5 h-5" />
            ë‹¨ì–´ì¥ í†µí•©
          </DialogTitle>
          <DialogDescription>
            ì„ íƒí•œ ë‹¨ì–´ì¥ì„ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤ (ì¤‘ë³µ ë‹¨ì–´ ìë™ ì œê±°)
          </DialogDescription>
        </DialogHeader>

        {loadingPreview ? (
          <div className="flex items-center justify-center py-8">
            <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
          </div>
        ) : (
          <div className="space-y-4">
            {/* ì„ íƒëœ ë‹¨ì–´ì¥ ëª©ë¡ */}
            <Card className="p-4">
              <div className="space-y-2">
                <Label className="text-sm font-medium">
                  ì„ íƒëœ ë‹¨ì–´ì¥ ({wordlistIds.length}ê°œ)
                </Label>
                <div className="space-y-2 max-h-40 overflow-y-auto">
                  {wordlistsInfo.map((w, idx) => (
                    <div key={w.id} className="flex items-center gap-2 text-sm">
                      <Badge variant="outline" className="shrink-0">
                        {idx + 1}
                      </Badge>
                      <span className="flex-1 truncate">{w.name}</span>
                      <span className="text-muted-foreground shrink-0">
                        {w.totalWords}ê°œ
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            </Card>

            {/* í†µê³„ ì •ë³´ */}
            <Card className="p-4 bg-blue-50 dark:bg-blue-900/20">
              <div className="space-y-1 text-sm">
                <div className="flex justify-between">
                  <span>ì´ ë‹¨ì–´ ìˆ˜:</span>
                  <span className="font-semibold">{totalWords}ê°œ</span>
                </div>
                <div className="flex justify-between text-muted-foreground text-xs pt-1 border-t">
                  <span>ìƒì„± ì˜ˆìƒ:</span>
                  <span>ì¤‘ë³µ ì œê±° í›„ í™•ì •</span>
                </div>
              </div>
            </Card>

            {/* ìƒˆ ì´ë¦„ ì…ë ¥ */}
            <div className="space-y-2">
              <Label htmlFor="merged-name">
                ìƒˆ ë‹¨ì–´ì¥ ì´ë¦„ <span className="text-red-500">*</span>
              </Label>
              <Input
                id="merged-name"
                placeholder="ì˜ˆ: í†µí•© ë‹¨ì–´ì¥ 1"
                value={mergedName}
                onChange={(e) => setMergedName(e.target.value)}
                disabled={isMerging}
              />
            </div>

            {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
            <Alert>
              <AlertCircle className="h-4 w-4" />
              <AlertDescription className="text-xs space-y-1">
                <div><strong>ì¤‘ë³µ ë‹¨ì–´ ìë™ ì œê±°:</strong></div>
                <div>ê°™ì€ ì² ìì˜ ë‹¨ì–´ëŠ” í•˜ë‚˜ë§Œ í¬í•¨ë©ë‹ˆë‹¤ (ì²« ë²ˆì§¸ ë‹¨ì–´ì¥ ìš°ì„ )</div>
                <div className="text-orange-600 pt-1">
                  <strong>âš ï¸ ì‹ ê·œ í•™ìƒ ë°°ì • ê¶Œì¥</strong>
                </div>
              </AlertDescription>
            </Alert>

            {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
            {error && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{error}</AlertDescription>
              </Alert>
            )}
          </div>
        )}

        {/* ë²„íŠ¼ */}
        <DialogFooter className="gap-2">
          <Button
            variant="outline"
            onClick={handleClose}
            disabled={isMerging}
          >
            ì·¨ì†Œ
          </Button>
          <Button
            onClick={handleMerge}
            disabled={isMerging || !mergedName.trim() || loadingPreview}
          >
            {isMerging ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                í†µí•© ì¤‘...
              </>
            ) : (
              <>
                <Merge className="w-4 h-4 mr-2" />
                í†µí•© ìƒì„±
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}

